tinymce.PluginManager.add('img', function(editor, url) {

  console.log( 'img', editor.settings );
  // Add a button that opens a window
  editor.addButton('img', {
    icon: "image",
    tooltip: 'Insert/edit image',
    onclick: function() {
      // Open window

      var fw = $(this.$el.closest('[role=toolbar]')).outerWidth() - 70;

      // .outerWidth()

      MediaGallery.open({
        getData: editor.settings.getData,
        selector: true,
        selector_limit: 1,

        done: function (resp) {

          var result = resp.checked[0];
          // Insert content when the window form is submitted
          if( result ){


            // 
            var tw = result.size.width;
            var th = result.size.height;

            if( tw > fw ){
                tw = fw;
                th = ( result.size.height*fw)/result.size.width
            }


            editor.execCommand("mceInsertContent", false, '<img class="img" alt="'+result.name+'" src="'+result.url+'" width="'+tw+'" height="'+th+'"/>' );
            editor.execCommand("mceInsertContent", false, '<p></p>');
            editor.execCommand("mceFocus");

            // editor.insertContent( 'Title: ');
            // .execCommand("mceInsertContent", false, self.img);
          }

        }
      });
    }
  });

  return {
    getMetadata: function () {
      return  {
        title: "Example plugin",
        url: "http://exampleplugindocsurl.com"
      };
    }
  };
});
